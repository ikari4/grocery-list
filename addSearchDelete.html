<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="styles.css">
  <title>Grocery List</title>
</head>
<body>
    <h1>Add New Item</h1>
    <form id="groceryList">
        <div class="form-group">
            <label for="itemName">Item:</label>
            <input type="text" name="itemName">
        </div>
        <div class="form-group">
            <label for="category">Category:</label>
            <!-- <input type="text" name="category"> -->
            <select name="category" id="category" required>
                <option disabled selected value="">Select Category</option>
                <option value="Alcohol">Alcohol</option>
                <option value="Bakery">Bakery</option>
                <option value="Dairy">Dairy</option>
                <option value="Frozen">Frozen</option>
                <option value="Grocery">Grocery</option>
                <option value="Household">Household</option>
                <option value="Meat">Meat</option>
                <option value="Produce">Produce</option>
            </select>
        </div>
        <div class="form-group">
            <label for="store">Store:</label>
            <select name="store" id="store" required>
                <option disabled selected value="">Select Store</option>
                <option value="Big Y">Big Y</option>
                <option value="BJs">BJs</option>
                <option value="Trader Joes">Trader Joes</option>
            </select>
        </div>
        <div class="buttonDiv">
            <button type="submit" >Submit</button>
        </div>
    </form>
    <br>
    <div id="addMsg" role="status"></div>
    <hr>
    <h1>Search For Item</h1>
    <form id="search">
        <div class="form-group">
            <label for="searchItem">Search:</label>
            <input type="text" name="searchItem" id="searchItem">
        </div>
        <div class="buttonDiv">
            <button type="submit" id="searchBtn">Search</button>
        </div>
    </form>
    <br>
    <div id="searchMsg" role="status"></div>
    <div id="listArea"></div>
    <hr>
    <br>
    <div class="buttonDiv">
        <button id="backHome">Back</button>
    </div>

    <script>
        const form = document.getElementById('groceryList');
        const addMsg = document.getElementById('addMsg');
        const searchMsg = document.getElementById('searchMsg');
        const backBtn = document.getElementById('backHome');
        const searchForm = document.getElementById('search');
        const listArea = document.getElementById('listArea');
        const searchBtn = document.getElementById('searchBtn');

        // helper to escape HTML for safe insertion into the DOM
        function escapeHtml(str) {
            return String(str ?? '').replace(/[&<>"']/g, s => (
                {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]
            ));
        }

        // Submit Add Form
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                itemName: form.itemName.value.trim(),
                category: form.category.value.trim(),
                store: form.store.value.trim(),
            };

            try {
                const res = await fetch('/api/post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
                });

                const json = await res.json();
                if (res.ok) {
                    addMsg.textContent = 'Saved â€” thank you!';
                    searchMsg.textContent = '';
                    form.reset();
                } else {
                    addMsg.textContent = 'Error: ' + (json?.error || res.statusText);
                    searchMsg.textContent = '';
                }
            } catch (err) {
                addMsg.textContent = 'Network error: ' + err.message;
                searchMsg.textContent = '';
            }
        });

        // Submit Search Form
        searchForm.addEventListener('submit', async (e) => {
            searchBtn.disabled = true;
            searchBtn.textContent = 'Wait...';
            listArea.innerHTML = '';
            e.preventDefault();
            const searchItem = searchForm.searchItem.value.trim()

            try {
                const res = await fetch(`/api/get-search?searchTerm=${encodeURIComponent(searchItem)}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const json = await res.json();
                const results = json.items;

                if (res.ok) {
                    if (!results.length) {
                        searchBtn.disabled = false;
                        searchBtn.textContent = 'Search';
                        searchMsg.textContent = 'No results found';
                        addMsg.textContent = '';
                        return;
                    }

                    // build table
                    const table = document.createElement('table');
                    table.className = 'results-table';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>&#x2713</th>
                                <th>Results</th>
                                <th>&#128465</th>
                            </tr>
                        </thead>
                    `;
                    const tbody = document.createElement('tbody');
                    results.forEach(r => {
                        const tr = document.createElement('tr');
                        // checkbox for adding item to grocery list
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = r.checked === 1;
                        // button for deleting item from database
                        const deleteMe = document.createElement('button');
                        deleteMe.textContent = 'X';

                        if (r.id !=null) checkbox.dataset.id=String(r.id);
                        
                        // When checkbox changes, update DB and refresh list
                        checkbox.addEventListener('change', async () => {
                            try {
                                const patchRes = await fetch('/api/patch', {
                                    method: 'PATCH',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ id: checkbox.dataset.id, checked: checkbox.checked })
                                });

                                if (patchRes.ok) {
                                    searchMsg.textContent = `Updated "${r.item_name}" successfully.`;
                                    addMsg.textContent = '';
                                } else {
                                    searchMsg.textContent = `Error updating "${r.item_name}".`;
                                    addMsg.textContent = '';
                                }
                            } catch (err) {
                                searchMsg.textContent = 'Network error: ' + err.message;
                                addMsg.textContent = '';
                            }
                        });

                        // When delete button is clicked, delete from DB
                        deleteMe.addEventListener('click', async() => {
                            try {
                                const patchRes = await fetch('/api/delete', {
                                    method: 'DELETE',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ id: checkbox.dataset.id })
                                });

                                if (patchRes.ok) {
                                    searchMsg.textContent = `Deleted "${r.item_name}" successfully.`;
                                    addMsg.textContent = '';
                                    tr.classList.add("deletedRow");
                                    checkbox.disabled = true;
                                    deleteMe.disabled = true;
                                } else {
                                    searchMsg.textContent = `Error deleting "${r.item_name}".`;
                                    addMsg.textContent = '';
                                }

                            } catch (err) {
                                searchMsg.textContent = 'Network error: ' + err.message;
                                addMsg.textContent = '';
                            }
                        });

                        const item = r.item_name ?? '';
                        const store = r.store ?? '';
                        const category = r.category ?? '';
                        tr.innerHTML = `
                            <td class="cb-cell"></td>
                            <td>${escapeHtml(item)}<br>
                            ${escapeHtml(store)}<br>
                            ${escapeHtml(category)}</td>
                            <td class="del-Btn"></td>
                        `;

                        const cbCell = tr.querySelector('.cb-cell');
                        if (cbCell) cbCell.appendChild(checkbox);
                        
                        const delBtn = tr.querySelector('.del-Btn');
                        if (delBtn) delBtn.appendChild(deleteMe);

                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    listArea.appendChild(table);
                    searchMsg.textContent = `Found ${results.length} item(s)`;
                    addMsg.textContent = '';
                    searchBtn.disabled = false;
                    searchBtn.textContent = 'Search';
                    searchForm.reset();

                } else {
                    searchBtn.disabled = false;
                    searchBtn.textContent = 'Search';
                    serachMsg.textContent = 'Error: ' + (json?.error || res.statusText);
                    addMsg.textContent = '';
                    
                }
            } catch (err) {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
                searchMsg.textContent = 'Network error: ' + err.message;
                addMsg.textContent = '';
            }
            
        });

        // Go To Add to Database Page
        backBtn.addEventListener('click', async () => {
            window.location.href = "index.html";
        });
    </script>
</body>