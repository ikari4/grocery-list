<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="styles.css">
  <title>Grocery List</title>
</head>
<body>
    <h1>Add New Item</h1>

    <form id="groceryList">
        <div class="form-group">
            <label for="itemName">Item:</label>
            <input type="text" name="itemName">
        </div>
        <div class="form-group">
            <label for="category">Category:</label>
            <!-- <input type="text" name="category"> -->
            <select name="category" id="category" required>
                <option disabled selected value="">Select Category</option>
                <option value="Alcohol">Alcohol</option>
                <option value="Bakery">Bakery</option>
                <option value="Dairy">Dairy</option>
                <option value="Frozen">Frozen</option>
                <option value="Grocery">Grocery</option>
                <option value="Household">Household</option>
                <option value="Meat">Meat</option>
                <option value="Produce">Produce</option>
            </select>
        </div>
        <div class="form-group">
            <label for="store">Store:</label>
            <select name="store" id="store" required>
                <option disabled selected value="">Select Store</option>
                <option value="Big Y">Big Y</option>
                <option value="BJs">BJs</option>
                <option value="Trader Joes">Trader Joes</option>
            </select>
        </div>
        <div class="addButtons">
            <button type="submit" >Submit</button>
            <button id="backHome">Back</button>
        </div>
    </form>
    <br>
    <hr>
    <br>
    <h1>Search For Item</h1>
    <form id="search">
        <div class="form-group">
            <label for="searchItem">Search:</label>
            <input type="text" name="searchItem" id="searchItem">
        </div>
        <div class="searchButton">
            <button type="submit" id="searchBtn">Search</button>
        </div>
    </form>
    <br>
    <div id="listArea"></div>
    
    <div id="msg" role="status"></div>
    
    <script>
        const form = document.getElementById('groceryList');
        const msg = document.getElementById('msg');
        const backBtn = document.getElementById('backHome');
        const searchForm = document.getElementById('search');
        const listArea = document.getElementById('listArea');

        // helper to escape HTML for safe insertion into the DOM
        function escapeHtml(str) {
            return String(str ?? '').replace(/[&<>"']/g, s => (
                {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]
            ));
        }

        // Submit Add Form
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                itemName: form.itemName.value.trim(),
                category: form.category.value.trim(),
                store: form.store.value.trim(),
            };

            try {
                const res = await fetch('/api/grocery', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
                });

                const json = await res.json();
                if (res.ok) {
                msg.textContent = 'Saved â€” thank you!';
                form.reset();
                } else {
                msg.textContent = 'Error: ' + (json?.error || res.statusText);
                }
            } catch (err) {
                msg.textContent = 'Network error: ' + err.message;
            }
        });

        // Submit Search Form
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const searchItem = searchForm.searchItem.value.trim()

            try {
                const res = await fetch(`/api/search?searchTerm=${encodeURIComponent(searchItem)}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const json = await res.json();
                const results = json.items;

                if (res.ok) {
                    if (!results.length) {
                        listArea.textContent = 'No results found';
                        msg.textContent = 'No matches';
                        return;
                    }

                    // build table
                    const table = document.createElement('table');
                    table.className = 'results-table';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Store</th>
                                <th>Category</th>
                            </tr>
                        </thead>
                    `;
                    const tbody = document.createElement('tbody');
                    results.forEach(r => {
                        const tr = document.createElement('tr');
                        // handle possible property names: item_name, itemName, item
                        const item = r.item_name ?? r.itemName ?? r.item ?? '';
                        const store = r.store ?? '';
                        const category = r.category ?? '';
                        tr.innerHTML = `
                            <td>${escapeHtml(item)}</td>
                            <td>${escapeHtml(store)}</td>
                            <td>${escapeHtml(category)}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);

                    listArea.innerHTML = '';
                    listArea.appendChild(table);

                    msg.textContent = `Found ${results.length} item(s)`;
                    // optionally clear the search input:
                    searchForm.reset();

                } else {
                    msg.textContent = 'Error: ' + (json?.error || res.statusText);
                }
            } catch (err) {
                msg.textContent = 'Network error: ' + err.message;
            }
        });


        // Go To Add to Database Page
        backBtn.addEventListener('click', async () => {
            window.location.href = "index.html";
        });
    </script>
</body>